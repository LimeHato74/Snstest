<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PenGuin üêß - Write it cool.</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
            --primary: #00A8E8;
            --primary-dark: #007EA7;
            --secondary: #003459;
            --accent: #FFD400;
            --bg: #F0F4F8;
            --white: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #e1e8ed;
            --radius: 16px;
            --shadow: 0 4px 12px rgba(0, 52, 89, 0.05);
            --like-color: #e0245e;
            --repost-color: #17bf63;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Zen Maru Gothic', 'Nunito', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
        }

        .sidebar {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border-right: 1px solid var(--border);
            background: var(--bg);
        }

        .brand {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        .brand i { color: var(--primary); }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            border-radius: 99px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-btn:hover { background-color: #E1F1F6; color: var(--primary); }
        .nav-btn.active { color: var(--primary); }
        
        .btn-tweet {
            background-color: var(--primary);
            color: white;
            text-align: center;
            justify-content: center;
            margin-top: 1rem;
            box-shadow: 0 4px 10px rgba(0, 168, 232, 0.3);
        }
        .btn-tweet:hover { background-color: var(--primary-dark); transform: translateY(-2px); }

        .main-feed {
            overflow-y: auto;
            border-right: 1px solid var(--border);
            background: var(--white);
            position: relative;
        }

        .header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem;
            font-weight: 700;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        .compose-box {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #eee;
            object-fit: cover;
            border: 2px solid var(--white);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .compose-area {
            flex: 1;
        }
        
        textarea {
            width: 100%;
            border: none;
            resize: none;
            font-family: inherit;
            font-size: 1.1rem;
            outline: none;
            padding: 0.5rem 0;
            min-height: 60px;
        }

        .compose-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 0.5rem;
            gap: 15px;
        }

        .char-counter {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 700;
            transition: color 0.2s;
        }
        .char-counter.limit-near { color: #f39c12; }
        .char-counter.limit-over { color: #e74c3c; }

        .btn-sm {
            padding: 8px 20px;
            border-radius: 99px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            background: var(--primary);
            color: white;
            transition: 0.2s;
        }
        .btn-sm:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }

        .post {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            transition: background 0.2s;
            animation: fadeIn 0.5s ease;
        }
        .post:hover { background-color: #fafafa; }
        
        .post-content { flex: 1; }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .user-name { font-weight: 700; color: var(--text); }
        .post-time { font-size: 0.85rem; color: var(--text-light); }
        .post-text { white-space: pre-wrap; word-break: break-word; }

        .post-actions {
            margin-top: 10px;
            display: flex;
            gap: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .action-item {
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-item:hover { color: var(--primary); }
        .action-item.delete:hover { color: #e0245e; }
        
        /* „ÅÑ„ÅÑ„Å≠Èñ¢ÈÄ£ */
        .action-item.liked {
            color: var(--like-color);
        }
        .action-item.liked i {
            animation: heartBeat 0.3s ease;
        }
        
        /* „É™„Éù„Çπ„ÉàÈñ¢ÈÄ£ */
        .action-item.reposted {
            color: var(--repost-color);
        }
        
        .repost-indicator {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .repost-indicator i {
            color: var(--repost-color);
        }

        /* „Ç≥„É°„É≥„Éà„Çª„ÇØ„Ç∑„Éß„É≥ */
        .comments-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            display: none;
        }
        
        .comments-section.active {
            display: block;
        }
        
        .comment-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .comment-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.95rem;
            outline: none;
        }
        
        .comment-input:focus {
            border-color: var(--primary);
        }
        
        .comment-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .comment-btn:hover {
            background: var(--primary-dark);
        }
        
        .comment-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .comment-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        
        .comment-content {
            flex: 1;
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 2px;
        }
        
        .comment-author {
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .comment-time {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .comment-text {
            font-size: 0.9rem;
            margin-top: 2px;
        }
        
        .comments-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .comments-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .comments-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .comments-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }
        
        .comments-list::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        
        .comment-delete {
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .comment-delete:hover {
            color: #e0245e;
        }

        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #e0f7fa 0%, #fff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 52, 89, 0.15);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-card h1 {
            font-size: 2.5rem;
            color: var(--secondary);
            margin-bottom: 1rem;
        }
        .login-card h1 i { color: var(--primary); }

        .login-card p {
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: border 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .hidden { display: none !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(-20px);
                background: rgba(0, 168, 232, 0.1);
            }
            to { 
                opacity: 1; 
                transform: translateX(0);
                background: transparent;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-overlay">
        <div class="login-card">
            <h1><i class="fa-solid fa-fish"></i> PenGuin</h1>
            <p>Write it cool. üêß</p>
            <div class="input-group">
                <input type="email" id="email" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
            </div>
            <button class="btn-primary" onclick="handleAuth()">„É≠„Ç∞„Ç§„É≥ / „Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-screen" class="hidden">
        <div class="app-container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <a href="#" class="brand">
                    <i class="fa-solid fa-fish"></i> PenGuin
                </a>
                <a href="#" class="nav-btn active">
                    <i class="fa-solid fa-house"></i> „Éõ„Éº„É†
                </a>
                <a href="#" class="nav-btn">
                    <i class="fa-solid fa-user"></i> „Éó„É≠„Éï„Ç£„Éº„É´
                </a>
                <a href="#" class="nav-btn" onclick="handleLogout()">
                    <i class="fa-solid fa-right-from-bracket"></i> „É≠„Ç∞„Ç¢„Ç¶„Éà
                </a>
                <button class="nav-btn btn-tweet" onclick="document.getElementById('post-content').focus()">
                    Pen!
                </button>
            </aside>

            <!-- Main Feed -->
            <main class="main-feed">
                <div class="header">„Éõ„Éº„É†</div>

                <div class="compose-box">
                    <img id="user-avatar" src="" class="avatar" alt="You">
                    <div class="compose-area">
                        <textarea id="post-content" placeholder="‰ªä„Å©„ÅÜ„Åó„Å¶„ÇãÔºü" maxlength="140"></textarea>
                        <div class="compose-actions">
                            <span id="char-count" class="char-counter">0/140</span>
                            <button id="post-btn" class="btn-sm" onclick="submitPost()" disabled>Pen!</button>
                        </div>
                    </div>
                </div>

                <div id="timeline"></div>
            </main>

            <!-- Right Sidebar (Empty for now) -->
            <aside style="padding: 1rem; background: var(--bg);"></aside>
        </div>
    </div>

    <script>
        // Cloudflare Worker„ÅÆURLÔºà„Éá„Éó„É≠„Ç§Âæå„Å´Êõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ
        const CONFIG_WORKER_URL = 'https://shrill-block-fafd.boleft704.workers.dev/';
        
        // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÁî®„ÅÆÂ§âÊï∞
        let supabaseClient;
        let supabaseError = null;
        let configLoaded = false;
        
        let currentUser = null;
        let postSubscription = null;
        let likeSubscription = null;
        let repostSubscription = null;
        let commentSubscription = null;
        let likesData = {};
        let repostsData = {};
        let commentsData = {};

        // Cloudflare Worker„Åã„ÇâË™çË®ºÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶Supabase„ÇíÂàùÊúüÂåñ
        async function initializeSupabase() {
            try {
                const response = await fetch(CONFIG_WORKER_URL);
                
                if (!response.ok) {
                    throw new Error(`Worker response error: ${response.status}`);
                }
                
                const config = await response.json();
                
                if (!config.supabaseUrl || !config.supabaseAnonKey) {
                    throw new Error('SupabaseË™çË®ºÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíÂàùÊúüÂåñ
                supabaseClient = supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                configLoaded = true;
                
                console.log('‚úÖ Supabase initialized successfully');
                
            } catch (error) {
                supabaseError = error.message;
                console.error('‚ùå SupabaseÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                
                // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                if (error.message.includes('Failed to fetch') || error.message.includes('Worker response error')) {
                    supabaseError = 'Cloudflare Worker„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇCONFIG_WORKER_URL„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                }
            }
        }

        async function init() {
            // „Åæ„ÅöCloudflare Worker„Åã„ÇâË™çË®ºÊÉÖÂ†±„ÇíÂèñÂæó
            await initializeSupabase();
            
            if (supabaseError) {
                showLogin();
                document.getElementById('login-overlay').innerHTML = `
                    <div class="login-card">
                        <h1 style="color:#e74c3c;">‚ö†Ô∏è Ë®≠ÂÆö„Ç®„É©„Éº</h1>
                        <p>${supabaseError}</p>
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: left;">
                            <p style="font-weight: bold; margin-bottom: 10px;">Ë®≠ÂÆöÊâãÈ†Ü:</p>
                            <ol style="margin-left: 20px; color:#666; font-size:14px;">
                                <li>Cloudflare Worker„Çí„Éá„Éó„É≠„Ç§</li>
                                <li>WorkerË®≠ÂÆö„ÅßSUPABASE_URL„Å®SUPABASE_ANON_KEY„ÇíSecret„Å®„Åó„Å¶ËøΩÂä†</li>
                                <li>HTML„Éï„Ç°„Ç§„É´„ÅÆ477Ë°åÁõÆ„ÅÆCONFIG_WORKER_URL„ÇíÊõ¥Êñ∞</li>
                            </ol>
                        </div>
                    </div>
                `;
                return;
            }
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                showApp();
                await Promise.all([
                    fetchPosts(),
                    fetchLikes(),
                    fetchReposts(),
                    fetchComments()
                ]);
                subscribeToPosts();
                subscribeToLikes();
                subscribeToReposts();
                subscribeToComments();
            } else {
                showLogin();
            }

            supabaseClient.auth.onAuthStateChange((_event, session) => {
                if (session) {
                    currentUser = session.user;
                    showApp();
                    fetchPosts();
                    fetchLikes();
                    fetchReposts();
                    fetchComments();
                } else {
                    showLogin();
                }
            });

            const textarea = document.getElementById('post-content');
            const charCount = document.getElementById('char-count');
            const postBtn = document.getElementById('post-btn');

            textarea.addEventListener('input', () => {
                const length = textarea.value.length;
                charCount.textContent = `${length}/140`;
                
                charCount.className = 'char-counter';
                if (length > 130) charCount.classList.add('limit-near');
                if (length > 140) charCount.classList.add('limit-over');
                
                postBtn.disabled = length === 0 || length > 140;
            });
        }

        function showApp() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-avatar').src = getAvatarUrl(currentUser.email);
        }

        function showLogin() {
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }

        async function handleAuth() {
            if (supabaseError || !configLoaded) {
                alert('‚ö†Ô∏è Ë®≠ÂÆö„Ç®„É©„Éº\n\n' + (supabaseError || 'Supabase„ÅÆË®≠ÂÆö„Åå„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì') + '\n\nCloudflare Worker„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showToast("„É°„Éº„É´„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "error");
                return;
            }

            showToast("Âá¶ÁêÜ‰∏≠...", "info");

            const { error: signInError } = await supabaseClient.auth.signInWithPassword({ email, password });
            
            if (signInError) {
                const { error: signUpError } = await supabaseClient.auth.signUp({ 
                    email, 
                    password,
                    options: { emailRedirectTo: window.location.href }
                });

                if (signUpError) {
                    showToast(signUpError.message, "error");
                } else {
                    showToast("Á¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ„Çä„Åæ„Åó„ÅüÔºÅ„É°„Éº„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Å≠„ÄÇ", "success");
                }
            } else {
                showToast("„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ", "success");
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            showToast("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü", "info");
        }

        async function submitPost() {
            const content = document.getElementById('post-content').value;
            const btn = document.getElementById('post-btn');
            
            if (!content.trim() || content.length > 140) return;

            btn.disabled = true;
            btn.textContent = "Pen...";

            const { data, error } = await supabaseClient.from('posts').insert([
                { user_id: currentUser.id, email: currentUser.email, content: content }
            ]).select();

            btn.disabled = false;
            btn.textContent = "Pen!";

            if (error) {
                showToast("ÊäïÁ®øÂ§±Êïó: " + error.message, "error");
            } else {
                document.getElementById('post-content').value = "";
                document.getElementById('char-count').textContent = "0/140";
                document.getElementById('char-count').className = "char-counter";
                document.getElementById('post-btn').disabled = true;

                showToast("ÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ", "success");
                
                if (data && data.length > 0) {
                    addPostToDOM(data[0], true);
                }
            }
        }

        async function deletePost(postId) {
            if(!confirm("Êú¨ÂΩì„Å´„Åì„ÅÆÊäïÁ®ø„ÇíÊ∂à„Åó„Åæ„Åô„ÅãÔºü")) return;

            const { error } = await supabaseClient
                .from('posts')
                .delete()
                .eq('id', postId)
                .eq('user_id', currentUser.id);

            if (error) {
                showToast("ÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: " + error.message, "error");
            } else {
                showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü", "info");
                const el = document.getElementById(`post-${postId}`);
                if(el) el.remove();
            }
        }

        // === „ÅÑ„ÅÑ„Å≠Ê©üËÉΩ ===

        async function fetchLikes() {
            const { data, error } = await supabaseClient
                .from('likes')
                .select('*');
            
            if (!error && data) {
                likesData = {};
                data.forEach(like => {
                    if (!likesData[like.post_id]) {
                        likesData[like.post_id] = { count: 0, users: [] };
                    }
                    likesData[like.post_id].count++;
                    likesData[like.post_id].users.push(like.user_id);
                });
            }
        }

        async function toggleLike(postId) {
            const likeInfo = likesData[postId] || { count: 0, users: [] };
            const isLiked = likeInfo.users.includes(currentUser.id);

            if (isLiked) {
                const { error } = await supabaseClient
                    .from('likes')
                    .delete()
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id);

                if (!error) {
                    likesData[postId].count--;
                    likesData[postId].users = likesData[postId].users.filter(id => id !== currentUser.id);
                    updateLikeUI(postId);
                }
            } else {
                const { error } = await supabaseClient
                    .from('likes')
                    .insert([{ post_id: postId, user_id: currentUser.id }]);

                if (!error) {
                    if (!likesData[postId]) {
                        likesData[postId] = { count: 0, users: [] };
                    }
                    likesData[postId].count++;
                    likesData[postId].users.push(currentUser.id);
                    updateLikeUI(postId);
                }
            }
        }

        function updateLikeUI(postId) {
            const likeBtn = document.querySelector(`#post-${postId} .like-btn`);
            if (!likeBtn) return;

            const likeInfo = likesData[postId] || { count: 0, users: [] };
            const isLiked = likeInfo.users.includes(currentUser.id);

            likeBtn.className = `action-item like-btn ${isLiked ? 'liked' : ''}`;
            likeBtn.innerHTML = `
                <i class="fa${isLiked ? '-solid' : '-regular'} fa-heart"></i>
                ${likeInfo.count > 0 ? likeInfo.count : ''}
            `;
        }

        function subscribeToLikes() {
            if (likeSubscription) return;

            likeSubscription = supabaseClient.channel('public:likes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'likes' }, payload => {
                    fetchLikes().then(() => {
                        if (payload.new && payload.new.post_id) {
                            updateLikeUI(payload.new.post_id);
                        }
                        if (payload.old && payload.old.post_id) {
                            updateLikeUI(payload.old.post_id);
                        }
                    });
                })
                .subscribe();
        }

        // === „É™„Éù„Çπ„ÉàÊ©üËÉΩ ===

        async function fetchReposts() {
            const { data, error } = await supabaseClient
                .from('reposts')
                .select('*');
            
            if (!error && data) {
                repostsData = {};
                data.forEach(repost => {
                    if (!repostsData[repost.post_id]) {
                        repostsData[repost.post_id] = { count: 0, users: [] };
                    }
                    repostsData[repost.post_id].count++;
                    repostsData[repost.post_id].users.push(repost.user_id);
                });
            }
        }

        async function toggleRepost(postId) {
            const repostInfo = repostsData[postId] || { count: 0, users: [] };
            const isReposted = repostInfo.users.includes(currentUser.id);

            if (isReposted) {
                const { error } = await supabaseClient
                    .from('reposts')
                    .delete()
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id);

                if (!error) {
                    repostsData[postId].count--;
                    repostsData[postId].users = repostsData[postId].users.filter(id => id !== currentUser.id);
                    updateRepostUI(postId);
                    showToast("„É™„Éù„Çπ„Éà„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü", "info");
                }
            } else {
                const { error } = await supabaseClient
                    .from('reposts')
                    .insert([{ post_id: postId, user_id: currentUser.id }]);

                if (!error) {
                    if (!repostsData[postId]) {
                        repostsData[postId] = { count: 0, users: [] };
                    }
                    repostsData[postId].count++;
                    repostsData[postId].users.push(currentUser.id);
                    updateRepostUI(postId);
                    showToast("„É™„Éù„Çπ„Éà„Åó„Åæ„Åó„ÅüÔºÅ", "success");
                }
            }
        }

        function updateRepostUI(postId) {
            const repostBtn = document.querySelector(`#post-${postId} .repost-btn`);
            if (!repostBtn) return;

            const repostInfo = repostsData[postId] || { count: 0, users: [] };
            const isReposted = repostInfo.users.includes(currentUser.id);

            repostBtn.className = `action-item repost-btn ${isReposted ? 'reposted' : ''}`;
            repostBtn.innerHTML = `
                <i class="fa-solid fa-retweet"></i>
                ${repostInfo.count > 0 ? repostInfo.count : ''}
            `;
        }

        function subscribeToReposts() {
            if (repostSubscription) return;

            repostSubscription = supabaseClient.channel('public:reposts')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'reposts' }, payload => {
                    fetchReposts().then(() => {
                        if (payload.new && payload.new.post_id) {
                            updateRepostUI(payload.new.post_id);
                        }
                        if (payload.old && payload.old.post_id) {
                            updateRepostUI(payload.old.post_id);
                        }
                    });
                })
                .subscribe();
        }

        // === „Ç≥„É°„É≥„ÉàÊ©üËÉΩ ===

        async function fetchComments() {
            const { data, error } = await supabaseClient
                .from('comments')
                .select('*')
                .order('created_at', { ascending: true });
            
            if (!error && data) {
                commentsData = {};
                data.forEach(comment => {
                    if (!commentsData[comment.post_id]) {
                        commentsData[comment.post_id] = [];
                    }
                    commentsData[comment.post_id].push(comment);
                });
            }
        }

        function toggleComments(postId) {
            const commentsSection = document.querySelector(`#post-${postId} .comments-section`);
            if (!commentsSection) return;

            const wasActive = commentsSection.classList.contains('active');
            commentsSection.classList.toggle('active');
            
            if (!wasActive) {
                // „Ç≥„É°„É≥„Éà„ÇíÈñã„ÅÑ„Åü„Å®„Åç
                renderComments(postId);
                const input = commentsSection.querySelector('.comment-input');
                if (input) {
                    // Â∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶„Åã„Çâ„Éï„Ç©„Éº„Ç´„ÇπÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂæåÔºâ
                    setTimeout(() => {
                        input.focus();
                        // „Ç≥„É°„É≥„Éà„É™„Çπ„Éà„ÅÆÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
                        const commentsList = commentsSection.querySelector('.comments-list');
                        if (commentsList) {
                            commentsList.scrollTop = commentsList.scrollHeight;
                        }
                    }, 100);
                }
            }
        }

        function renderComments(postId) {
            const container = document.querySelector(`#post-${postId} .comments-list`);
            if (!container) return;

            const comments = commentsData[postId] || [];
            const previousScrollHeight = container.scrollHeight;
            const wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;
            
            if (comments.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-light); font-size:0.9rem; padding:10px;">„Åæ„Å†„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            container.innerHTML = comments.map(comment => {
                const isMine = currentUser.id === comment.user_id;
                const timeAgo = timeSince(new Date(comment.created_at));
                return `
                    <div class="comment-item">
                        <img src="${getAvatarUrl(comment.email)}" class="comment-avatar" alt="User">
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">${sanitize(comment.email.split('@')[0])}</span>
                                <span class="comment-time">¬∑ ${timeAgo}</span>
                            </div>
                            <div class="comment-text">${sanitize(comment.content)}</div>
                        </div>
                        ${isMine ? `<span class="comment-delete" onclick="deleteComment('${comment.id}', '${postId}')"><i class="fa-solid fa-trash"></i></span>` : ''}
                    </div>
                `;
            }).join('');
            
            // Êñ∞„Åó„ÅÑ„Ç≥„É°„É≥„Éà„ÅåËøΩÂä†„Åï„Çå„ÅüÂ†¥Âêà„ÄÅËá™ÂãïÁöÑ„Å´ÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
            if (wasAtBottom || container.scrollHeight > previousScrollHeight) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            }
        }

        async function submitComment(postId) {
            const input = document.querySelector(`#post-${postId} .comment-input`);
            const btn = document.querySelector(`#post-${postId} .comment-btn`);
            
            if (!input || !btn) return;
            
            const content = input.value.trim();
            if (!content) return;

            btn.disabled = true;
            btn.textContent = 'ÈÄÅ‰ø°‰∏≠...';

            const { error } = await supabaseClient
                .from('comments')
                .insert([{
                    post_id: postId,
                    user_id: currentUser.id,
                    email: currentUser.email,
                    content: content
                }]);

            btn.disabled = false;
            btn.textContent = 'ÈÄÅ‰ø°';

            if (error) {
                showToast("„Ç≥„É°„É≥„ÉàÂ§±Êïó: " + error.message, "error");
            } else {
                input.value = '';
                // „É™„Ç¢„É´„Çø„Ç§„É†„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÅåËá™ÂãïÁöÑ„Å´UI„ÇíÊõ¥Êñ∞„Åô„Çã„Åü„ÇÅ„ÄÅ
                // „Åì„Åì„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„Éà„Éº„Çπ„Éà„ÅÆ„ÅøË°®Á§∫Ôºâ
                showToast("„Ç≥„É°„É≥„Éà„Åó„Åæ„Åó„ÅüÔºÅ", "success");
            }
        }

        async function deleteComment(commentId, postId) {
            if (!confirm("„Åì„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;

            const { error } = await supabaseClient
                .from('comments')
                .delete()
                .eq('id', commentId)
                .eq('user_id', currentUser.id);

            if (error) {
                showToast("ÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: " + error.message, "error");
            } else {
                showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü", "info");
            }
        }

        function updateCommentCount(postId) {
            const commentBtn = document.querySelector(`#post-${postId} .comment-btn`);
            if (!commentBtn) return;

            const comments = commentsData[postId] || [];
            commentBtn.innerHTML = `
                <i class="fa-regular fa-comment"></i>
                ${comments.length > 0 ? comments.length : ''}
            `;
        }

        function subscribeToComments() {
            if (commentSubscription) return;

            commentSubscription = supabaseClient.channel('public:comments')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, payload => {
                    // Êñ∞„Åó„ÅÑ„Ç≥„É°„É≥„Éà„ÅåËøΩÂä†„Åï„Çå„Åü„Å®„Åç - Âç≥Â∫ß„Å´ÂèçÊò†
                    const comment = payload.new;
                    if (!commentsData[comment.post_id]) {
                        commentsData[comment.post_id] = [];
                    }
                    commentsData[comment.post_id].push(comment);
                    
                    // UI„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                    renderComments(comment.post_id);
                    updateCommentCount(comment.post_id);
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú„ÇíËøΩÂä†
                    const commentsList = document.querySelector(`#post-${comment.post_id} .comments-list`);
                    if (commentsList && commentsList.lastElementChild) {
                        commentsList.lastElementChild.style.animation = 'slideIn 0.3s ease';
                    }
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'comments' }, payload => {
                    // „Ç≥„É°„É≥„Éà„ÅåÂâäÈô§„Åï„Çå„Åü„Å®„Åç
                    const comment = payload.old;
                    if (commentsData[comment.post_id]) {
                        commentsData[comment.post_id] = commentsData[comment.post_id].filter(c => c.id !== comment.id);
                    }
                    
                    // UI„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                    renderComments(comment.post_id);
                    updateCommentCount(comment.post_id);
                })
                .subscribe();
        }

        async function fetchPosts() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = ''; 

            const { data, error } = await supabaseClient
                .from('posts')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) {
                timeline.innerHTML = '<p style="text-align:center; padding:20px;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü üò¢</p>';
                return;
            }

            if (!data || data.length === 0) {
                timeline.innerHTML = '<p style="text-align:center; padding:20px;">„Åæ„Å†ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰∏ÄÁï™‰πó„Çä„Åó„Çà„ÅÜÔºÅ</p>';
                return;
            }

            data.forEach(post => addPostToDOM(post));
        }

        function subscribeToPosts() {
            if (postSubscription) return;

            postSubscription = supabaseClient.channel('public:posts')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, payload => {
                    addPostToDOM(payload.new, true);
                })
                .subscribe();
        }

        function addPostToDOM(post, prepend = false) {
            if (document.getElementById(`post-${post.id}`)) return;

            const timeline = document.getElementById('timeline');
            if (timeline.children.length === 1 && timeline.children[0].tagName === 'P') {
                timeline.innerHTML = '';
            }

            const avatarUrl = getAvatarUrl(post.email);
            const timeAgo = timeSince(new Date(post.created_at));
            const isMine = currentUser && currentUser.id === post.user_id;
            
            const contentHtml = linkify(sanitize(post.content));

            // „ÅÑ„ÅÑ„Å≠„Éª„É™„Éù„Çπ„Éà„ÅÆÊÉÖÂ†±
            const likeInfo = likesData[post.id] || { count: 0, users: [] };
            const isLiked = likeInfo.users.includes(currentUser.id);
            
            const repostInfo = repostsData[post.id] || { count: 0, users: [] };
            const isReposted = repostInfo.users.includes(currentUser.id);
            
            const comments = commentsData[post.id] || [];

            const div = document.createElement('div');
            div.className = 'post';
            div.id = `post-${post.id}`; 
            
            div.innerHTML = `
                <img src="${avatarUrl}" class="avatar" alt="User">
                <div class="post-content">
                    <div class="post-header">
                        <div>
                            <span class="user-name">${sanitize(post.email.split('@')[0])}</span>
                            <span class="post-time">¬∑ ${timeAgo}</span>
                        </div>
                    </div>
                    <div class="post-text">${contentHtml}</div>
                    
                    <div class="post-actions">
                        <span class="action-item comment-btn" onclick="toggleComments('${post.id}')">
                            <i class="fa-regular fa-comment"></i>
                            ${comments.length > 0 ? comments.length : ''}
                        </span>
                        <span class="action-item repost-btn ${isReposted ? 'reposted' : ''}" onclick="toggleRepost('${post.id}')">
                            <i class="fa-solid fa-retweet"></i>
                            ${repostInfo.count > 0 ? repostInfo.count : ''}
                        </span>
                        <span class="action-item like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
                            <i class="fa${isLiked ? '-solid' : '-regular'} fa-heart"></i>
                            ${likeInfo.count > 0 ? likeInfo.count : ''}
                        </span>
                        ${isMine ? `<span class="action-item delete" onclick="deletePost('${post.id}')"><i class="fa-solid fa-trash"></i></span>` : ''}
                    </div>
                    
                    <div class="comments-section">
                        <div class="comment-input-area">
                            <input type="text" class="comment-input" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ..." maxlength="200">
                            <button class="comment-btn" onclick="submitComment('${post.id}')">ÈÄÅ‰ø°</button>
                        </div>
                        <div class="comments-list"></div>
                    </div>
                </div>
            `;

            if (prepend) {
                timeline.prepend(div);
            } else {
                timeline.appendChild(div);
            }
            
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÅÆ„Ç®„É≥„Çø„Éº„Ç≠„ÉºÂØæÂøú
            const commentInput = div.querySelector('.comment-input');
            if (commentInput) {
                commentInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        submitComment(post.id);
                    }
                });
            }
        }

        function getAvatarUrl(seed) {
            return `https://api.dicebear.com/9.x/avataaars/svg?seed=${seed}&backgroundColor=b6e3f4`;
        }

        function sanitize(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }
        
        function linkify(text) {
             var urlRegex = /(https?:\/\/[^\s]+)/g;
             return text.replace(urlRegex, function(url) {
                 return '<a href="' + url + '" target="_blank" style="color:var(--primary)">' + url + '</a>';
             });
        }

        function showToast(msg, type = "info") {
            const colors = {
                info: "#00A8E8",
                success: "#00b894",
                error: "#d63031"
            };
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "top", 
                position: "center", 
                style: {
                    background: colors[type]
                },
                stopOnFocus: true,
            }).showToast();
        }

        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "Âπ¥Ââç";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "„É∂ÊúàÂâç";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "Êó•Ââç";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "ÊôÇÈñìÂâç";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "ÂàÜÂâç";
            return "„Åü„Å£„Åü‰ªä";
        }

        init();
    </script>
</body>
</html>
