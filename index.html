<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PenGuin üêß - Write it cool.</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
            --primary: #00A8E8;
            --primary-dark: #007EA7;
            --secondary: #003459;
            --accent: #FFD400;
            --bg: #F0F4F8;
            --white: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #e1e8ed;
            --radius: 16px;
            --shadow: 0 4px 12px rgba(0, 52, 89, 0.05);
            --like-color: #e0245e;
            --repost-color: #17bf63;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Zen Maru Gothic', 'Nunito', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
        }

        .sidebar {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border-right: 1px solid var(--border);
            background: var(--bg);
        }

        .brand {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        .brand i { color: var(--primary); }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            border-radius: 99px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-btn:hover { background-color: #E1F1F6; color: var(--primary); }
        .nav-btn.active { color: var(--primary); }
        
        .btn-tweet {
            background-color: var(--primary);
            color: white;
            text-align: center;
            justify-content: center;
            margin-top: 1rem;
            box-shadow: 0 4px 10px rgba(0, 168, 232, 0.3);
        }
        .btn-tweet:hover { background-color: var(--primary-dark); transform: translateY(-2px); }

        .main-feed {
            overflow-y: auto;
            border-right: 1px solid var(--border);
            background: var(--white);
            position: relative;
        }

        .header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem;
            font-weight: 700;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        .compose-box {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #eee;
            object-fit: cover;
            border: 2px solid var(--white);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .compose-area {
            flex: 1;
        }
        
        textarea {
            width: 100%;
            border: none;
            resize: none;
            font-family: inherit;
            font-size: 1.1rem;
            outline: none;
            padding: 0.5rem 0;
            min-height: 60px;
        }

        .compose-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 0.5rem;
            gap: 15px;
        }

        .char-counter {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 700;
            transition: color 0.2s;
        }
        .char-counter.limit-near { color: #f39c12; }
        .char-counter.limit-over { color: #e74c3c; }

        .btn-sm {
            padding: 8px 20px;
            border-radius: 99px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            background: var(--primary);
            color: white;
            transition: 0.2s;
        }
        .btn-sm:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }

        .post {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            transition: background 0.2s;
            animation: fadeIn 0.5s ease;
        }
        .post:hover { background-color: #fafafa; }
        
        .post-content { flex: 1; }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .user-name { font-weight: 700; color: var(--text); }
        .post-time { font-size: 0.85rem; color: var(--text-light); }
        .post-text { white-space: pre-wrap; word-break: break-word; }

        .post-actions {
            margin-top: 10px;
            display: flex;
            gap: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .action-item {
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-item:hover { color: var(--primary); }
        .action-item.delete:hover { color: #e0245e; }
        
        .like-btn.liked { color: var(--like-color); animation: pulse 0.3s; }
        .like-btn.liked i { color: var(--like-color); }
        
        .repost-btn.reposted { color: var(--repost-color); animation: pulse 0.3s; }
        .repost-btn.reposted i { color: var(--repost-color); }

        .comments-section {
            margin-top: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .comments-section.open { max-height: 1000px; }
        
        .comment-input-area {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .comment-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.9rem;
            outline: none;
        }
        
        .comment-input:focus { border-color: var(--primary); }
        
        .comment-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            transition: 0.2s;
        }
        
        .comment-btn:hover { background: var(--primary-dark); }
        
        .comments-list {
            margin-top: 10px;
        }
        
        .comment-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
            animation: slideIn 0.3s ease;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .comment-user {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        .comment-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        .comment-text {
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .right-sidebar {
            padding: 2rem;
            background: var(--bg);
            overflow-y: auto;
        }

        .widget {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .widget-title {
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--secondary);
        }

        .trend-item, .user-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
        }
        .trend-item:hover, .user-item:hover { background: #fafafa; }
        .trend-item:last-child, .user-item:last-child { border-bottom: none; }
        
        .trend-name { font-weight: 700; color: var(--text); }
        .trend-count { font-size: 0.8rem; color: var(--text-light); }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-item .avatar { width: 40px; height: 40px; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            .sidebar, .right-sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <a href="#" class="brand">
                <i class="fa-solid fa-fish"></i> PenGuin
            </a>
            <nav>
                <a href="#" class="nav-btn active"><i class="fa-solid fa-house"></i> „Éõ„Éº„É†</a>
                <a href="#" class="nav-btn"><i class="fa-solid fa-magnifying-glass"></i> Êé¢Á¥¢</a>
                <a href="#" class="nav-btn"><i class="fa-solid fa-bell"></i> ÈÄöÁü•</a>
                <a href="#" class="nav-btn"><i class="fa-solid fa-envelope"></i> „É°„ÉÉ„Çª„Éº„Ç∏</a>
                <a href="#" class="nav-btn"><i class="fa-solid fa-user"></i> „Éó„É≠„Éï„Ç£„Éº„É´</a>
            </nav>
            <a href="#" class="nav-btn btn-tweet" onclick="focusTweet(event)">ÊäïÁ®ø„Åô„Çã</a>
        </aside>

        <main class="main-feed">
            <div class="header">„Éõ„Éº„É†</div>

            <div class="compose-box">
                <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=user&backgroundColor=b6e3f4" class="avatar" id="user-avatar" alt="User Avatar">
                <div class="compose-area">
                    <textarea id="tweet-input" placeholder="‰ªä‰Ωï„Åó„Å¶„ÇãÔºü"></textarea>
                    <div class="compose-actions">
                        <span class="char-counter" id="char-counter">0/280</span>
                        <button class="btn-sm" id="post-btn" onclick="postTweet()" disabled>ÊäïÁ®ø</button>
                    </div>
                </div>
            </div>

            <div id="timeline"></div>
        </main>

        <aside class="right-sidebar">
            <div class="widget">
                <div class="widget-title">„ÅÑ„ÅæËµ∑„Åç„Å¶„ÅÑ„Çã„Åì„Å®</div>
                <div class="trend-item">
                    <div class="trend-name">#PenGuin</div>
                    <div class="trend-count">1,234 posts</div>
                </div>
                <div class="trend-item">
                    <div class="trend-name">#CoolWriting</div>
                    <div class="trend-count">987 posts</div>
                </div>
                <div class="trend-item">
                    <div class="trend-name">#WebDev</div>
                    <div class="trend-count">543 posts</div>
                </div>
            </div>

            <div class="widget">
                <div class="widget-title">„Åä„Åô„Åô„ÇÅ„É¶„Éº„Ç∂„Éº</div>
                <div class="user-item">
                    <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=alice&backgroundColor=b6e3f4" class="avatar" alt="User">
                    <div>
                        <div class="user-name">alice</div>
                        <div class="trend-count">@alice</div>
                    </div>
                </div>
                <div class="user-item">
                    <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=bob&backgroundColor=b6e3f4" class="avatar" alt="User">
                    <div>
                        <div class="user-name">bob</div>
                        <div class="trend-count">@bob</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const SUPABASE_URL = 'https://dcamxlwobdjjlggjuapx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjYW14bHdvYmRqamxnZ2p1YXB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc2NTI5MjAsImV4cCI6MjA1MzIyODkyMH0.3E7xMz-hnK_3bNx2RBZ_brvLO7cwOLlw9eqO56c-a50';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let postSubscription = null;
        let likeSubscription = null;
        let repostSubscription = null;
        let commentSubscription = null;
        
        let likesData = {};
        let repostsData = {};
        let commentsData = {};

        async function init() {
            await initUser();
            updateUI();
            await Promise.all([
                fetchPosts(),
                fetchAllLikes(),
                fetchAllReposts(),
                fetchAllComments()
            ]);
            subscribeToPosts();
            subscribeToLikes();
            subscribeToReposts();
            subscribeToComments();
        }

        async function initUser() {
            const stored = localStorage.getItem('penguin_user');
            if (stored) {
                currentUser = JSON.parse(stored);
                return;
            }

            const email = prompt("„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:");
            if (!email) {
                alert("„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÂøÖË¶Å„Åß„Åô");
                return initUser();
            }

            const { data, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('email', email)
                .single();

            if (data) {
                currentUser = data;
            } else {
                const { data: newUser, error: insertError } = await supabaseClient
                    .from('users')
                    .insert([{ email, name: email.split('@')[0] }])
                    .select()
                    .single();

                if (newUser) {
                    currentUser = newUser;
                    showToast("„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ", "success");
                } else {
                    alert("„É¶„Éº„Ç∂„Éº‰ΩúÊàê„Ç®„É©„Éº");
                    return initUser();
                }
            }

            localStorage.setItem('penguin_user', JSON.stringify(currentUser));
        }

        function updateUI() {
            if (!currentUser) return;
            const avatar = document.getElementById('user-avatar');
            avatar.src = getAvatarUrl(currentUser.email);
        }

        const tweetInput = document.getElementById('tweet-input');
        const charCounter = document.getElementById('char-counter');
        const postBtn = document.getElementById('post-btn');

        tweetInput.addEventListener('input', () => {
            const length = tweetInput.value.length;
            charCounter.textContent = `${length}/280`;
            postBtn.disabled = length === 0 || length > 280;

            if (length > 260) charCounter.className = 'char-counter limit-near';
            else if (length > 280) charCounter.className = 'char-counter limit-over';
            else charCounter.className = 'char-counter';
        });

        async function postTweet() {
            const content = tweetInput.value.trim();
            if (!content || !currentUser) return;

            const { data, error } = await supabaseClient
                .from('posts')
                .insert([{
                    user_id: currentUser.id,
                    email: currentUser.email,
                    content: content
                }])
                .select()
                .single();

            if (error) {
                showToast("ÊäïÁ®ø„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü", "error");
                return;
            }

            tweetInput.value = '';
            charCounter.textContent = '0/280';
            postBtn.disabled = true;
            showToast("ÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅüêß", "success");
        }

        async function deletePost(postId) {
            if (!confirm("Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;

            const { error } = await supabaseClient
                .from('posts')
                .delete()
                .eq('id', postId);

            if (!error) {
                const postEl = document.getElementById(`post-${postId}`);
                if (postEl) postEl.remove();
                showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü", "success");
            } else {
                showToast("ÂâäÈô§„Ç®„É©„Éº", "error");
            }
        }

        function focusTweet(e) {
            e.preventDefault();
            tweetInput.focus();
        }

        async function fetchAllLikes() {
            const { data, error } = await supabaseClient
                .from('likes')
                .select('*');

            if (!error && data) {
                likesData = {};
                data.forEach(like => {
                    if (!likesData[like.post_id]) {
                        likesData[like.post_id] = { count: 0, users: [] };
                    }
                    likesData[like.post_id].count++;
                    likesData[like.post_id].users.push(like.user_id);
                });
            }
        }

        async function fetchAllReposts() {
            const { data, error } = await supabaseClient
                .from('reposts')
                .select('*');

            if (!error && data) {
                repostsData = {};
                data.forEach(repost => {
                    if (!repostsData[repost.post_id]) {
                        repostsData[repost.post_id] = { count: 0, users: [] };
                    }
                    repostsData[repost.post_id].count++;
                    repostsData[repost.post_id].users.push(repost.user_id);
                });
            }
        }

        async function fetchAllComments() {
            const { data, error } = await supabaseClient
                .from('comments')
                .select('*')
                .order('created_at', { ascending: true });

            if (!error && data) {
                commentsData = {};
                data.forEach(comment => {
                    if (!commentsData[comment.post_id]) {
                        commentsData[comment.post_id] = [];
                    }
                    commentsData[comment.post_id].push(comment);
                });
            }
        }

        async function toggleLike(postId) {
            if (!currentUser) return;

            const likeInfo = likesData[postId] || { count: 0, users: [] };
            const isLiked = likeInfo.users.includes(currentUser.id);

            if (isLiked) {
                const { error } = await supabaseClient
                    .from('likes')
                    .delete()
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id);

                if (!error) {
                    likesData[postId].count--;
                    likesData[postId].users = likesData[postId].users.filter(id => id !== currentUser.id);
                    updateLikeUI(postId);
                }
            } else {
                const { error } = await supabaseClient
                    .from('likes')
                    .insert([{ post_id: postId, user_id: currentUser.id }]);

                if (!error) {
                    if (!likesData[postId]) {
                        likesData[postId] = { count: 0, users: [] };
                    }
                    likesData[postId].count++;
                    likesData[postId].users.push(currentUser.id);
                    updateLikeUI(postId);
                }
            }
        }

        function updateLikeUI(postId) {
            const likeBtn = document.querySelector(`#post-${postId} .like-btn`);
            if (!likeBtn) return;

            const likeInfo = likesData[postId] || { count: 0, users: [] };
            const isLiked = likeInfo.users.includes(currentUser.id);

            likeBtn.classList.toggle('liked', isLiked);
            likeBtn.innerHTML = `
                <i class="fa${isLiked ? '-solid' : '-regular'} fa-heart"></i>
                ${likeInfo.count > 0 ? likeInfo.count : ''}
            `;
        }

        function subscribeToLikes() {
            if (likeSubscription) return;

            likeSubscription = supabaseClient.channel('public:likes')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'likes' }, payload => {
                    const like = payload.new;
                    if (!likesData[like.post_id]) {
                        likesData[like.post_id] = { count: 0, users: [] };
                    }
                    likesData[like.post_id].count++;
                    likesData[like.post_id].users.push(like.user_id);
                    updateLikeUI(like.post_id);
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'likes' }, payload => {
                    const like = payload.old;
                    if (likesData[like.post_id]) {
                        likesData[like.post_id].count--;
                        likesData[like.post_id].users = likesData[like.post_id].users.filter(id => id !== like.user_id);
                        updateLikeUI(like.post_id);
                    }
                })
                .subscribe();
        }

        async function toggleRepost(postId) {
            if (!currentUser) return;

            const repostInfo = repostsData[postId] || { count: 0, users: [] };
            const isReposted = repostInfo.users.includes(currentUser.id);

            if (isReposted) {
                const { error } = await supabaseClient
                    .from('reposts')
                    .delete()
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id);

                if (!error) {
                    repostsData[postId].count--;
                    repostsData[postId].users = repostsData[postId].users.filter(id => id !== currentUser.id);
                    updateRepostUI(postId);
                }
            } else {
                const { error } = await supabaseClient
                    .from('reposts')
                    .insert([{ post_id: postId, user_id: currentUser.id }]);

                if (!error) {
                    if (!repostsData[postId]) {
                        repostsData[postId] = { count: 0, users: [] };
                    }
                    repostsData[postId].count++;
                    repostsData[postId].users.push(currentUser.id);
                    updateRepostUI(postId);
                }
            }
        }

        function updateRepostUI(postId) {
            const repostBtn = document.querySelector(`#post-${postId} .repost-btn`);
            if (!repostBtn) return;

            const repostInfo = repostsData[postId] || { count: 0, users: [] };
            const isReposted = repostInfo.users.includes(currentUser.id);

            repostBtn.classList.toggle('reposted', isReposted);
            repostBtn.innerHTML = `
                <i class="fa-solid fa-retweet"></i>
                ${repostInfo.count > 0 ? repostInfo.count : ''}
            `;
        }

        function subscribeToReposts() {
            if (repostSubscription) return;

            repostSubscription = supabaseClient.channel('public:reposts')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'reposts' }, payload => {
                    const repost = payload.new;
                    if (!repostsData[repost.post_id]) {
                        repostsData[repost.post_id] = { count: 0, users: [] };
                    }
                    repostsData[repost.post_id].count++;
                    repostsData[repost.post_id].users.push(repost.user_id);
                    updateRepostUI(repost.post_id);
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'reposts' }, payload => {
                    const repost = payload.old;
                    if (repostsData[repost.post_id]) {
                        repostsData[repost.post_id].count--;
                        repostsData[repost.post_id].users = repostsData[repost.post_id].users.filter(id => id !== repost.user_id);
                        updateRepostUI(repost.post_id);
                    }
                })
                .subscribe();
        }

        function toggleComments(postId) {
            const section = document.querySelector(`#post-${postId} .comments-section`);
            if (!section) return;

            const isOpen = section.classList.contains('open');
            section.classList.toggle('open');

            if (!isOpen) {
                renderComments(postId);
            }
        }

        async function submitComment(postId) {
            const input = document.querySelector(`#post-${postId} .comment-input`);
            if (!input) return;

            const content = input.value.trim();
            if (!content || !currentUser) return;

            const { data, error } = await supabaseClient
                .from('comments')
                .insert([{
                    post_id: postId,
                    user_id: currentUser.id,
                    email: currentUser.email,
                    content: content
                }])
                .select()
                .single();

            if (!error) {
                input.value = '';
            } else {
                showToast("„Ç≥„É°„É≥„ÉàÊäïÁ®ø„Ç®„É©„Éº", "error");
            }
        }

        function renderComments(postId) {
            const commentsList = document.querySelector(`#post-${postId} .comments-list`);
            if (!commentsList) return;

            const comments = commentsData[postId] || [];
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align:center; color:var(--text-light); padding:10px; font-size:0.9rem;">„Åæ„Å†„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            commentsList.innerHTML = comments.map(comment => {
                const timeAgo = timeSince(new Date(comment.created_at));
                return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div>
                                <span class="comment-user">${sanitize(comment.email.split('@')[0])}</span>
                                <span class="comment-time">¬∑ ${timeAgo}</span>
                            </div>
                        </div>
                        <div class="comment-text">${sanitize(comment.content)}</div>
                    </div>
                `;
            }).join('');
        }

        function updateCommentCount(postId) {
            const commentBtn = document.querySelector(`#post-${postId} .comment-btn`);
            if (!commentBtn) return;

            const comments = commentsData[postId] || [];
            commentBtn.innerHTML = `
                <i class="fa-regular fa-comment"></i>
                ${comments.length > 0 ? comments.length : ''}
            `;
        }

        function subscribeToComments() {
            if (commentSubscription) return;

            commentSubscription = supabaseClient.channel('public:comments')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, payload => {
                    const comment = payload.new;
                    if (!commentsData[comment.post_id]) {
                        commentsData[comment.post_id] = [];
                    }
                    commentsData[comment.post_id].push(comment);
                    
                    renderComments(comment.post_id);
                    updateCommentCount(comment.post_id);
                    
                    const commentsList = document.querySelector(`#post-${comment.post_id} .comments-list`);
                    if (commentsList && commentsList.lastElementChild) {
                        commentsList.lastElementChild.style.animation = 'slideIn 0.3s ease';
                    }
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'comments' }, payload => {
                    const comment = payload.old;
                    if (commentsData[comment.post_id]) {
                        commentsData[comment.post_id] = commentsData[comment.post_id].filter(c => c.id !== comment.id);
                    }
                    
                    renderComments(comment.post_id);
                    updateCommentCount(comment.post_id);
                })
                .subscribe();
        }

        async function fetchPosts() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = ''; 

            const { data, error } = await supabaseClient
                .from('posts')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) {
                timeline.innerHTML = '<p style="text-align:center; padding:20px;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü üò¢</p>';
                return;
            }

            if (!data || data.length === 0) {
                timeline.innerHTML = '<p style="text-align:center; padding:20px;">„Åæ„Å†ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰∏ÄÁï™‰πó„Çä„Åó„Çà„ÅÜ!</p>';
                return;
            }

            data.forEach(post => addPostToDOM(post));
        }

        function subscribeToPosts() {
            if (postSubscription) return;

            postSubscription = supabaseClient.channel('public:posts')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, payload => {
                    addPostToDOM(payload.new, true);
                })
                .subscribe();
        }

        function addPostToDOM(post, prepend = false) {
            if (document.getElementById(`post-${post.id}`)) return;

            const timeline = document.getElementById('timeline');
            if (timeline.children.length === 1 && timeline.children[0].tagName === 'P') {
                timeline.innerHTML = '';
            }

            const avatarUrl = getAvatarUrl(post.email);
            const timeAgo = timeSince(new Date(post.created_at));
            const isMine = currentUser && currentUser.id === post.user_id;
            
            const contentHtml = linkify(sanitize(post.content));

            const likeInfo = likesData[post.id] || { count: 0, users: [] };
            const isLiked = likeInfo.users.includes(currentUser.id);
            
            const repostInfo = repostsData[post.id] || { count: 0, users: [] };
            const isReposted = repostInfo.users.includes(currentUser.id);
            
            const comments = commentsData[post.id] || [];

            const div = document.createElement('div');
            div.className = 'post';
            div.id = `post-${post.id}`; 
            
            div.innerHTML = `
                <img src="${avatarUrl}" class="avatar" alt="User">
                <div class="post-content">
                    <div class="post-header">
                        <div>
                            <span class="user-name">${sanitize(post.email.split('@')[0])}</span>
                            <span class="post-time">¬∑ ${timeAgo}</span>
                        </div>
                    </div>
                    <div class="post-text">${contentHtml}</div>
                    
                    <div class="post-actions">
                        <span class="action-item comment-btn" onclick="toggleComments('${post.id}')">
                            <i class="fa-regular fa-comment"></i>
                            ${comments.length > 0 ? comments.length : ''}
                        </span>
                        <span class="action-item repost-btn ${isReposted ? 'reposted' : ''}" onclick="toggleRepost('${post.id}')">
                            <i class="fa-solid fa-retweet"></i>
                            ${repostInfo.count > 0 ? repostInfo.count : ''}
                        </span>
                        <span class="action-item like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
                            <i class="fa${isLiked ? '-solid' : '-regular'} fa-heart"></i>
                            ${likeInfo.count > 0 ? likeInfo.count : ''}
                        </span>
                        ${isMine ? `<span class="action-item delete" onclick="deletePost('${post.id}')"><i class="fa-solid fa-trash"></i></span>` : ''}
                    </div>
                    
                    <div class="comments-section">
                        <div class="comment-input-area">
                            <input type="text" class="comment-input" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ..." maxlength="200">
                            <button class="comment-btn" onclick="submitComment('${post.id}')">ÈÄÅ‰ø°</button>
                        </div>
                        <div class="comments-list"></div>
                    </div>
                </div>
            `;

            if (prepend) {
                timeline.prepend(div);
            } else {
                timeline.appendChild(div);
            }
            
            const commentInput = div.querySelector('.comment-input');
            if (commentInput) {
                commentInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        submitComment(post.id);
                    }
                });
            }
        }

        function getAvatarUrl(seed) {
            return `https://api.dicebear.com/9.x/avataaars/svg?seed=${seed}&backgroundColor=b6e3f4`;
        }

        function sanitize(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }
        
        function linkify(text) {
             var urlRegex = /(https?:\/\/[^\s]+)/g;
             return text.replace(urlRegex, function(url) {
                 return '<a href="' + url + '" target="_blank" style="color:var(--primary)">' + url + '</a>';
             });
        }

        function showToast(msg, type = "info") {
            const colors = {
                info: "#00A8E8",
                success: "#00b894",
                error: "#d63031"
            };
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "top", 
                position: "center", 
                style: {
                    background: colors[type]
                },
                stopOnFocus: true,
            }).showToast();
        }

        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "Âπ¥Ââç";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "„É∂ÊúàÂâç";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "Êó•Ââç";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "ÊôÇÈñìÂâç";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "ÂàÜÂâç";
            return "„Åü„Å£„Åü‰ªä";
        }

        init();
    </script>
</body>
</html>
